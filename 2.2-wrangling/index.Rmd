---
title: "Data manipulation with dplyr, purrr and broom"
subtitle: "SISBID 2016"
author: "Di Cook (dicook@monash.edu, @visnut); Heike Hofmann (heike.hofmann@gmail.com, @heike_hh)"
date: "`r Sys.Date()`"
output:
  ioslides_presentation:
    transition: default
    widescreen: true
css:
  styles.css
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.height = 4,
  fig.width = 8,
  fig.align = "center",
  cache = FALSE
)
library(ggplot2)
library(tidyr)
library(dplyr)
library(lubridate)
library(scales)
library(readr)
library(ggmap)
library(HLMdiag)
library(RColorBrewer)
library(gridExtra)
```

## Outline

- dplyr package: motivation, functions, chaining
- purrr and broom: working with lists, vectors of data frames

#Working with lots of models

## Why would we even do that???

- Hans Rosling can explain that really well in his [TED talk](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?language=en)

- gapminder software 

- gapminder also makes data available (in R through the package ```gapminder```)


##First Look

```{r}
library(gapminder)
qplot(data=gapminder, year, lifeExp, geom="line", group=country)

```

How would you describe this plot?

##Using models as exploratory tools

- Idea: fit a line to each one of the countries' life expectancies
- then use e.g. intercept and slope to characterise groups of countries

```{r, echo=FALSE}
library(dplyr)
library(tidyr)
library(purrr)

gapminder2 <- gapminder %>% mutate(year = year-1950)
by_country <- gapminder2 %>% 
  group_by(continent, country) %>% 
  nest()

by_country <- by_country %>% mutate(
    model = purrr::map(data, ~ lm(lifeExp ~ year, data = .))
)

by_country <- by_country %>% unnest(model %>% purrr::map(broom::tidy))
country_coefs <- by_country %>% select(continent, country, term, estimate) %>% spread(term, estimate)

qplot(`(Intercept)`, year, data=country_coefs, colour=continent) + scale_colour_brewer(palette="Dark2") + 
  xlab("Average Life Expectancy in 1950") +
  ylab("Average Gain in Life Expectancy per Year")
```

##Prepping

- `purrr` package has been unveiled in February (presented by Hadley Wickham at WOMBAT)
- you might have to re-install the packages ```tidyr``` and ```purrr```, i.e. run the following code:

```{r, eval=FALSE}
install.packages("tidyr")
install.packages("purrr")

library(tidyr)
library(purrr)
```

## Life Expectancy in the U.S.

```{r}
usa <- subset(gapminder, country=="United States")
head(usa)
```

##Life Expectancy in the U.S. since 1950

```{r}
qplot(data=usa, year, lifeExp) + geom_smooth(method="lm")
```

##Life Expectancy in the U.S. since 1950

```{r}
usa.lm <- lm(lifeExp~year, data=usa)
usa.lm
```

Intercept is estimated life expectancy at 0 BC - let's use 1950 for the first value:

```{r}
gapminder <- gapminder %>% mutate(year = year-1950)
```

##Nesting data

We don't want to subset the data for every country ... 

```nest()``` makes a data frame part of another data frame:

```{r}
by_country <- gapminder %>% group_by(continent, country) %>% nest()
head(by_country)
```

***

Each element of the ```data``` variable in ```by_country``` is a dataset:

```{r}
head(by_country$data[[1]])
lm(lifeExp~year, data=by_country$data[[1]])
```

##Fitting multiple models

Now we are using the ```map``` function in the package ```purrr```.

```map``` allows us to apply a function to each element of a list.

```{r}
by_country$model <- by_country$data %>% purrr::map(~lm(lifeExp~year, data=.))
head(by_country)
```

##On to the ```broom``` package

```broom``` allows to extract values from models on three levels:

- for each model: ```broom::glance```
- for each coefficient in the model: ```broom::tidy```
- for each value in the dataset: ```broom::augment```

```{r}
library(broom)
broom::glance(by_country$model[[1]])
broom::tidy(by_country$model[[1]])
```

***
```{r}
broom::augment(by_country$model[[1]])
```

##Extract values for each coefficient

Extract all countries automatically (hello ```map``` again!)

```{r}
by_country_coefs <- by_country %>% unnest(model %>% purrr::map(broom::tidy))
coefs <- by_country_coefs %>% select(country, continent, term, estimate) %>% spread(term, estimate)
```

and finally, a visualization:

```{r}
qplot(`(Intercept)`, year, colour=continent, data=coefs)
```

##Extract other model diagnostics

```{r}
by_country <- by_country %>% unnest(model %>% purrr::map(broom::glance))
by_country$country <- reorder(by_country$country, by_country$r.squared)
qplot(country, r.squared, colour=continent, data=by_country) +
  theme(axis.text.x=element_text(angle=-90, hjust=0)) +
  scale_colour_brewer(palette="Dark2")
```

## Compare groups of countries

```{r}
country_all <- by_country %>% unnest(data)
qplot(year+1950, lifeExp,  data=subset(country_all, r.squared <= 0.45), geom="line") +
  facet_wrap(~country)
```
What do the patterns mean?

***

```{r}
qplot(year+1950, lifeExp,  data=subset(country_all, between(r.squared, 0.45, 0.75)), geom="line") +
  facet_wrap(~country)
```

## Your turn

![](rainbow-lorikeet.png)

- extract residuals for each of the models and store it in a dataset together with country and continent information

- plot residuals across the years and fit a smooth. What does the pattern mean?



## Share and share alike

This work is licensed under the Creative Commons Attribution-Noncommercial 3.0 United States License. To view a copy of this license, visit http://creativecommons.org/licenses/by-nc/ 3.0/us/ or send a letter to Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.
